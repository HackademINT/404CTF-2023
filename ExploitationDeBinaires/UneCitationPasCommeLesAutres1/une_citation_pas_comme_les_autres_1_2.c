#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <unistd.h>

#define MAX_LENGTH 1000

int chosen_index = 0;

void write_quote()
{
    char buffer[MAX_LENGTH];
    printf("Que souhaitez-vous écrire ?\n");
    printf("[Vous] : ");
    fgets(buffer, MAX_LENGTH, stdin);
    fgets(buffer, MAX_LENGTH, stdin);
    printf("\nAu moment où vous vous apprêtiez à écrire : ");
    printf(buffer);
    printf("Vous remarquez des traces d'une citation qui semble avoir été effacée.\n");
    printf("Vous vous ravisez temporairement d'écrire sur le livre en attendant d'en savoir davantage.\n");
}

void pick_quote()
{
    FILE *fp;
    char buffer[MAX_LENGTH];
    int static num_quotes = 0;
    srand(time(NULL)); // initialise le générateur de nombres aléatoires

    // ouvre le fichier contenant les citations
    fp = fopen("citations.txt", "r");
    if (fp == NULL)
    {
        exit(EXIT_FAILURE);
    }

    if (num_quotes == 0)
    {
        // compte le nombre de citations dans le fichier
        while (fgets(buffer, MAX_LENGTH, fp) != NULL)
        {
            if (buffer[0] == '%')
            {
                num_quotes++;
            }
        }
    }
    if (num_quotes > 0)
    {
        // génère un nombre aléatoire entre 0 et num_quotes - 2
        chosen_index = rand() % (num_quotes - 1);
    }
    // revient au début du fichier
    rewind(fp);

    // lit et affiche la citation choisie
    int quote_count = 0;
    while (fgets(buffer, MAX_LENGTH, fp) != NULL)
    {
        if (buffer[0] == '%')
        {
            if (quote_count == chosen_index)
            {
                while (fgets(buffer, MAX_LENGTH, fp) != NULL && buffer[0] != '%')
                {
                    printf("%s", buffer);
                }
                break;
            }
            quote_count++;
        }
    }

    // ferme le fichier
    fclose(fp);
    fp = NULL;
}

void count_quotes()
{
    srand(time(NULL));
    int maxQuotes = rand() % (500 + 1);
    printf("Vous commencez à compter le nombre de citations présentes dans le livre.\n");
    printf("1\n");
    printf("2\n");
    printf("3\n");
    printf(".");
    sleep(1);
    printf(".");
    sleep(1);
    printf(".");
    sleep(1);
    printf("\n%d\n", maxQuotes);
    printf("Vous abdiquez et décidez de passer à autre chose.\n");
}

int main()
{
    setvbuf(stdout, NULL, _IONBF, 0);
    puts("Vous vous retrouvez face au livre.");
    int sel;
    while (1)
    {
        printf("\n1: Lire une citation\n");
        printf("2: Ecrire sur le livre\n");
        printf("3: Compter le nombre de citations\n");

        printf("4: Fermer le livre\n");
        printf(">>> ");
        fflush(stdout);
        if (1 != scanf("%d", &sel))
        {
            exit(0);
        }
        if (sel < 1 || sel > 6)
        {
            exit(0);
        }
        switch (sel)
        {
        case 1:
            pick_quote();
            break;
        case 2:
            write_quote();
            break;
        case 3:
            count_quotes();
            break;
        case 4:
            exit(0);
            break;
        default:
            break;
        }
    }
    return EXIT_SUCCESS;
}