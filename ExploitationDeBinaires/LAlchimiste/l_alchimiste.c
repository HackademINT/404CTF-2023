#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/auxv.h>

typedef struct item Item;
typedef struct character Character;

typedef struct item
{
  char name[64];
  void (*effect)(Character *c);
} Item;

typedef struct character
{
  int strength;
  int intelligence;
  int gold;
  Item *item;
} Character;

Character *createCharacter(int strength, int intelligence, int gold)
{
  Character *c = (Character *)malloc(sizeof(Character));
  c->strength = strength;
  c->intelligence = intelligence;
  c->gold = gold;
  c->item = NULL;
  return c;
}

__attribute__((used)) void incInt(Character *c)
{
  c->intelligence += 10;
}

void incStr(Character *c)
{
  c->strength += 10;
}

void buyStrUpPotion(Character *c)
{
  printf("\n***** Achat d'un élixir de force\n");
  Item *strUpPotion = malloc(sizeof(Item));
  printf("***** ~ %p\n", strUpPotion);
  strncpy(strUpPotion->name, "Elixir de force", 16);
  strUpPotion->effect = incStr;

  if (c->gold < 50)
  {
    printf("[Alchimiste] : Vous n'avez pas suffisamment de pièces d'or.\n");
    return;
  }
  c->item = strUpPotion;
  c->gold -= 50;
}

void useItem(Character *c)
{
  if (c->item == NULL)
  {
    printf("[Alchimiste] : Vous n'avez pas d'élixir de force en votre possession.\n");
    return;
  }
  printf("\n***** Elixir consommé\n");
  printf("***** Vous sentez votre force augmenter.\n");
  c->item->effect(c);
  printf("***** ~ %p\n", c->item);
  free(c->item);
}

void sendMessage()
{
  char *msg = malloc(sizeof(Item));
  printf("\n[Vous] : ");

  read(STDIN_FILENO, msg, sizeof(Item));
  /* if (fgets(msg, sizeof(Item), stdin) == NULL) */
  /* 	return; */
  printf("***** ~ %p\n", msg);
}

void showStats(Character *c)
{
  printf("Voici une estimation numérique de vos caractéristiques:\n");
  printf("\n\tFOR: %d\n\tINT: %d\n\tOR: %d", c->strength,
         c->intelligence, c->gold);
}

void view_flag(Character *c)
{

  char key[64];

  if (c->strength < 150 || c->intelligence < 150)
  {
    puts("[Alchimiste] : Vous n'avez pas prouvé votre valeur.");
    return;
  }

  FILE *flag = fopen("flag.txt", "r");
  if (flag == NULL)
  {
    exit(0);
  }
  if (fgets(key, sizeof(key), flag) == NULL)
    return;
  printf("[Alchimiste] : Voici la clé de la connaissance, comme promis.\n");
  printf("-----------------------------------------------\n");
  puts(key);
  printf("-----------------------------------------------\n");
  exit(0);
}

int main()
{
  setvbuf(stdout, NULL, _IONBF, 0);

  /* Create Character with STR:100 INT:50 GOLD: 100 */
  Character *c = createCharacter(100, 50, 100);
  // Intro énoncé
  puts("[Alchimiste] : En entrant ici, vous avez fait le premier pas vers l'aventure mystique de l'alchimie, où la recherche de la connaissance et de la sagesse est sans fin.");
  puts("[Alchimiste] : Montrez-moi votre force et votre intelligence, et je vous donnerai la clé de la porte de la connaissance.\n");

  puts("[Alchimiste] : N'hésitez pas à faire un tour dans mon modeste laboratoire, je suis sûr que vous trouverez quelque chose qui vous aidera à progresser.");

  int sel;
  while (1)
  {
    printf("\n1: Acheter un élixir de force\n");
    printf("2: Consommer un élixir de force\n");
    printf("3: Parler à l'alchimiste\n");
    printf("4: Montrer mes caractéristiques\n");
    printf("5: Obtenir la clé\n");

    printf("6: Sortir du cabinet d'alchimie\n");
    printf(">>> ");
    fflush(stdout);
    if (1 != scanf("%d", &sel))
    {
      exit(0);
    }
    if (sel < 1 || sel > 6)
    {
      exit(0);
    }
    switch (sel)
    {
    case 1:
      buyStrUpPotion(c);
      break;
    case 2:
      useItem(c);
      break;
    case 3:
      sendMessage();
      break;
    case 4:
      showStats(c);
      break;
    case 5:
      view_flag(c);
      break;
    case 6:
      exit(0);
    default:
      break;
    }
  }
}
