#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <stdbool.h>
#include <openssl/bio.h>
#include <openssl/evp.h>
#include <openssl/buffer.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/wait.h>

char *base64_decode(const char *encoded_string, int *decoded_length)
{
    BIO *bio, *b64;
    size_t len = strlen(encoded_string);
    char *buffer = (char *)malloc(len);
    memset(buffer, 0, len);
    *decoded_length = 0;

    b64 = BIO_new(BIO_f_base64());
    BIO_set_flags(b64, BIO_FLAGS_BASE64_NO_NL);
    bio = BIO_new_mem_buf(encoded_string, len);
    bio = BIO_push(b64, bio);

    *decoded_length = BIO_read(bio, buffer, len);

    BIO_free_all(bio);

    return buffer;
}

int rand_lim(int limit)
{

    int divisor = RAND_MAX / (limit + 1);
    int retval;

    do
    {

        retval = rand() / divisor;
    } while (retval > limit);

    return retval;
}

char picker(const char *charset)
{
    return charset[rand_lim(strlen(charset) - 1)];
}

// This function takes a base64 encoded strings as input, decodes it and unzip it using zlib.
// Thens it opens a file called ahah.txt and read the flag from it.
int flag()
{
    // Clear buffer
    char clear[40];
    fgets(clear, sizeof(clear), stdin);
    // Define the zip file name and the output file name
    const char *zip = "mystere.zip";
    const char *zip_output = "surprise.txt";
    // Define the base64 encoded string
    char s[1024];
    int decoded_length = 0;
    fgets(s, sizeof(s), stdin);
    s[strcspn(s, "\n")] = 0;
    remove(zip);
    remove(zip_output);
    // Decode the base64 encoded string and unzip it
    char *decoded_data = base64_decode(s, &decoded_length);

    FILE *file = fopen(zip, "wb");
    if (file != NULL)
    {
        fwrite(decoded_data, sizeof(char), decoded_length, file);
        fclose(file);
        file = NULL;
    }
    else
    {
        puts("[Gardes] : Vous comportement est inapropprié, vous êtes prié de retourner en salle de réception ou de quitter le château.");
        free(decoded_data);
        decoded_data = NULL;
        return EXIT_FAILURE;
    }
    if (fork() == 0)
    {
        int devNull = open("/dev/null", O_WRONLY);
        if (devNull < 0)
        {
            exit(EXIT_FAILURE);
        }

        // Redirect stderr to /dev/null
        dup2(devNull, fileno(stdout));
        dup2(devNull, fileno(stderr));
        close(devNull);
        char *command = "unzip";
        char *args[] = {"unzip", "mystere.zip", NULL};

        // Execute the unzip command
        execvp(command, args);
        exit(EXIT_SUCCESS);
    }
    wait(NULL);
    //  Open the output file and read the flag
    FILE *output_file = fopen(zip_output, "r");
    if (output_file == NULL)
    {
        puts("[Gardes] : Vous comportement est inapropprié, vous êtes prié de retourner en salle de réception ou de quitter le château.");
        free(decoded_data);
        decoded_data = NULL;
        return EXIT_FAILURE;
    }

    char *line = NULL;
    size_t len = 0;
    ssize_t nread;

    if ((nread = getline(&line, &len, output_file)) != -1)
    {
        puts(line);
    }
    else
    {
        puts("[Gardes] : Vous comportement est inapropprié, vous êtes prié de retourner en salle de réception ou de quitter le château.");
        return EXIT_FAILURE;
    }
    remove(zip);
    remove(zip_output);
    fclose(file);
    fclose(output_file);
    free(line);
    free(decoded_data);
    decoded_data = NULL;
    file = NULL;
    output_file = NULL;
    line = NULL;
    return EXIT_SUCCESS;
}

int main(int argc, char *argv[])
{
    setvbuf(stdout, NULL, _IONBF, 0);
    int len = 20;
    char password[21] = "";
    char cara = 'a';
    const char *groups[] = {
        "1234567890",
        "abcdefghijklmnoqprstuvwyzx",
        "ABCDEFGHIJKLMNOPQRSTUYWVZX",
        "!@#$%^&*(){}[]:<>?,./",
    };
    const size_t numGroups = sizeof(groups) / sizeof(groups[0]);

    srand((unsigned int)(time(NULL)));

    for (; len; --len)
    {
        unsigned group = rand_lim(numGroups - 1);
        cara = picker(groups[group]);
        strncat(password, &cara, 1);
    }
    password[sizeof(password) - 1] = '\0';
    puts("[Vous] : Toc toc toc");

    sleep(1);

    puts("[Portier] : Bienvenue au Château de La Buzine! Avez-vous le mot de passe ?");
    char buffer[21];
    fgets(buffer, sizeof(buffer), stdin);
    buffer[strcspn(buffer, "\n")] = 0;
    bool pass = strcmp(buffer, password) == 0;
    if (pass)
    {
        puts("[Portier] : Permettez-moi de vous souhaiter à nouveau chaleureusement la bienvenue !");
        puts("[Portier] : Si vous avez un cadeau, allez le déposer dans la salle_au_tresor.");
        puts("[Portier] : Vous trouverez facilement, il y a deux gardes devant la porte, au fond du couloir.");
        flag();
    }
    else
    {
        puts("[Portier] : Je me vois au regret de refuser votre entrée.");
    }

    return EXIT_SUCCESS;
}
