#include "PLFS.h"

// DEBUG : gcc -fstack-protector-all -ggdb3 PLFS.c -o PLFS
// PROD : gcc -fstack-protector-all -s PLFS.c -o PLFS && patchelf --set-rpath ./libs --set-interpreter ./libs/ld-linux-x86-64.so.2 PLFS

char *filenames[NB_FILES_MAX] = {0};
char *contents[NB_FILES_DEFAULT] = {CONTENT0, CONTENT1, CONTENT2, CONTENT3};

int main(int argc, char **argv)
{
    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    initfs();
    puts(HELLO);
    puts(HELPTEXT);

    char input[INPUT_MAX_LEN];
    char *in2;
    while (1)
    {
        in2 = input;
        printf("\n> ");
        if (fgets(input, INPUT_MAX_LEN, stdin) == NULL)
        {
            perror("fgets");
            exit(1);
        }
        input[strcspn(input, "\n")] = 0;
        char *command = strsep(&in2, " ");
        if (strcmp(command, EXIT) == 0)
        {
            break;
        }
        parse(command, in2);
    }
    return 0;
}

void initfs()
{
    filenames[0] = FILE0;
    filenames[1] = FILE1;
    filenames[2] = FILE2;
    filenames[3] = FILE3;
}

__always_inline void parse(char *command, char *argument)
{
    if (strcmp(command, HELP) == 0)
    {
        puts(HELPTEXT);
        return;
    }
    if (strcmp(command, LS) == 0 && argument == NULL)
    {
        for (int i = 0; i < NB_FILES_MAX; i++)
        {
            if (filenames[i])
            {
                puts(filenames[i]);
            }
        }
        return;
    }

    if (argument != NULL)
    {
        if (strcmp(command, PUT) == 0)
        {
            int i = 0;
            while (i < NB_FILES_MAX && filenames[i])
            {
                i++;
            }
            if (i < NB_FILES_MAX)
            {
                filenames[i] = (char *)malloc(strlen(argument) + 1);
                strcpy(filenames[i], argument);
                return;
            }
            else
            {
                puts("Le serveur est plein. Opération annulée.");
                return;
            }
        }

        if (strcmp(command, GET) == 0)
        {
            for (int i = 0; i < NB_FILES_DEFAULT; i++)
            {
                if (strcmp(filenames[i], argument) == 0)
                {
                    printf("Contenu du fichier : ");
                    printf(contents[i]);
                    return;
                }
            }
            puts("Le fichier spécifié n'a pas été trouvé ou n'a pas de contenu.");
            return;
        }

        if (strcmp(command, LS) == 0)
        {
            int found = 0;
            for (int i = 0; i < NB_FILES_MAX; i++)
            {
                if (filenames[i] && *argument && strstr(filenames[i], argument) == filenames[i])
                {
                    printf(filenames[i]);
                    printf("\n");
                    found = 1;
                }
            }
            if (!found)
                puts("Le fichier spécifié n'a pas été trouvé.");
            return;
        }

        if (strcmp(command, DEL) == 0)
        {
            for (int i = NB_FILES_DEFAULT; i < NB_FILES_MAX; i++)
            {
                if (filenames[i] && (strcmp(filenames[i], argument) == 0))
                {
                    free(filenames[i]);
                    filenames[i] = NULL;
                    puts("Fichier supprimé.");
                    return;
                }
            }
            puts("Le fichier spécifié n'a pas pu être supprimé.");
            return;
        }
    }

    puts(ERROR);
    puts(HELPTEXT);
    explicit_bzero(command, INPUT_MAX_LEN);
}
